#!/usr/bin/env bash
set -e

# Sanitize explicit lockfile (remove blank lines)
awk 'BEGIN{keep=0}
     /^@EXPLICIT/{print; keep=1; next}
     keep && NF {print}' conda-linux-64.lock > cleaned.lock
mv cleaned.lock conda-linux-64.lock

# Create the environment exactly
mamba create -p "${NB_PYTHON_PREFIX}" --yes --file conda-linux-64.lock

# pip packages
pip install -r <(awk '/^- /{print substr($0,3)}' environment-pip.yml | tail -n +2)

mamba clean --all --yes

jupyter server extension enable --py jupyterlab_s3_browser
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:home/jovyan/shared/Libraries/Matlab2024/R2024b/runtime/glnxa64:/home/jovyan/shared/Libraries/Matlab2024/R2024b/bin/glnxa64:/home/jovyan/shared/Libraries/Matlab2024/R2024b/sys/os/glnxa64:/home/jovyan/shared/Libraries/Matlab2024/R2024b/extern/bin/glnxa64:/home/jovyan/shared/Libraries/Matlab2024/R2024b/sys/opengl/lib/glnxa64
export PYTHONPATH=${PYTHONPATH}:/home/jovyan/shared/Models/clawpack:/home/jovyan/shared/Models/clawpack/src:/home/jovyan/shared/Models/clawpack/src/python:/home/jovyan/shared/Libraries
